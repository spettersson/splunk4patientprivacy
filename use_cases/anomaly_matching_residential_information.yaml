name: matching residential information
type: anomaly-triggering
description: looks for employees who access patient medical records where there is a potential residential link between the staff member and the patient. A match on residential address, street name, or postal code may indicate a personal relationship.
detection_ID: at03
prerequisites: 
- indexes: 
        anomaly_collection
- lookups: 
        patientpii_lookup
        staffpii_lookup
- macros: 
        NULL
- fields: 
          staff_ID
          patient_ID
- searches: 
          search_1

how_to_implement:

search_1: 
- description: 
- search: 
        tag=emraudit
        | fields _time, staff_ID, patient_ID
        | stats count by staff_ID, patient_ID
        | lookup patientpii_lookup patient_ID OUTPUT residential_street_name AS patient_residential_street_name, residential_street_number AS patient_residential_street_number, residential_postal_code AS patient_residential_postal_code, government_issued_id
        | lookup staffpii_lookup staff_ID OUTPUT residential_street_name AS staff_residential_street_name, residential_street_number AS staff_residential_street_number, residential_postal_code AS staff_residential_postal_code, government_issued_id
        | eval staff_residential_address_and_postal_code = staff_residential_street_name + staff_residential_street_number + staff_postal_code
        | eval patient_residential_address_and_postal_code = patient_residential_street_name + patient_residential_street_number + patient_postal_code
        | eval patient_residential_street_name_and_postal_code = patient_residential_street_name + patient_postal_code
        | eval staff_residential_street_name_and_postal_code = staff_residential_street_name + staff_postal_code
        | eval matching_address = if(staff_residential_address_and_postal_code == patient_residential_address_and_postal_code, "true", "false")
        | eval matching_street_name = if(staff_residential_street_name_and_postal_code  == patient_residential_street_name_and_postal_code , "true", "false")
        | eval matching_postal_code = if(staff_residential_postal_code == patient_residential_postal_code, "true", "false")
        | where matching_address="true" OR matching_street_name="true" OR matching_postal_code="true"
        | eval anomaly_risk_factor = case(
            matching_address == "true", 10, 
            matching_street_name == "true", 3,
            matching_postal_code == "true", 1, 
            true(), 1
        )			
        | addinfo
         | eval detection_ID = "at03"
         | eval detection_title = "matching residential information"
         | eval detection_description = "looks for employees who access patient medical records where there is a potential residential link between the staff member and the patient. A match on residential address, street name, or postal code may indicate a personal relationship."
         | eval anomaly_ID = md5(staff_ID.patient_ID.sid.info_search_time)
         | eval anomaly_message = "staff_ID=".staff_ID." accessed a patient medical record associated to patient_ID=".patient_ID." during hour ".hourOfDay." This is unusual for the employee during this hour of the day."
         | eval anomaly_risk_score = 10
         
        | eval anomaly_risk_score = anomaly_risk_factor * anomaly_risk_score
        | fields staff_*, patient_*, matching_*, risk_*, detection_*
        
        

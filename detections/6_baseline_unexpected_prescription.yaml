name: Baseline - Unexpected Prescription
id: b04be6e5-2u02-4349-8742-52145635y8f5
version: 1
author: Simon Pettersson, Splunk
type: Baseline
status: experimental
description: This search runs continuously to identify activities that should precede an 
staff members prescribing medication to patients. Each activity is sent and stored in dedicated index. 
data_source: EHR activity data
search: (tag=medication_request intent=order) 
        (tag=appointment status=fulfilled) (tag=encounter status=completed)
        | fields user_id, patient_id, care_unit_id, care_provider_id, tag, intent, status
        | eval type=case(
        tag="medication_request" AND intent="order", "medication_ordered",
        tag="appointment" AND status="fulfilled", "appointment_fullfilled",
        tag="encounter" AND status="completed", "encounter_completed",
        true(),null()
        )
        | reverse 
        | streamstats values(type) as values_type reset_after="("type=\"medication_ordered\"")" by user_id, patient_id, encounter_id, care_unit_id, care_provider_id
        | reverse
        | search values_type!="appointment_fullfilled" and values_type!="encounter_completed"
        |
        | fields user_id, patient_id, care_unit_id, care_provider_id, 
scheduling:
  cron_schedule: '*/10 * * * *'
  _index_earliest: -12min@min
  _index_latest: -2min@min

name: Unusual Access Hours
id: b04be6e5-2002-4349-8742-52111635y8f5
version: 1
author: Simon Pettersson, Splunk
type: Anomaly
status: experimental
description: This search runs continuously to detect accesses to patient records during hours that are unusual for the staff 
          member, based on the baseline built by search_1. If an access occurs at a rare or previously unseen hour 
          (percent â‰¤ 1 or null), an observation is created and stored as an event in index=risk.
search: tag=auditevent tag=patientrecord earliest=-12min@min latest=-2min@min
          | fields _time, user_id, patient_id, care_provider_id
          | eval hourOfDay = strftime(_time, "%H")
          | stats count by hourOfDay, user_id, patient_id, care_provider_id
          | lookup baseline_access_hours user_id hourOfDay OUTPUT percent AS historical_percent
          | where isnull(historical_percent) OR historical_percent<=1
          | eval detection_title = "Unusual Access Hours"
          | eval detection_description = "Looks for staff members members accessing patient medical records during unusual hours of the day, based on their own historical access patterns."
          | eval observation_message = "User=".user_id." accessed a patient medical record associated to patient=".patient_id." during hour ".hourOfDay." This is unusual for the staff member during this hour of the day."
          | eval observation_risk_score = 10
          | fields user_id, patient_id, care_provider_id, hourOfDay, detection_*, observation_*, info_*
how_to_implement: 
                    prerequisites:
                    - data sources:
                              EHR audit events from any source
                    - tags:
                              auditevent (=identifies all EHR audit events, regardless of source system)
                              patientrecord (=identifies all EHR audit events associated with patient records access, regardless of source system)
                    - indexes: 
                              observation (=where identified observations are stored as individual events)
                    - lookups: 
                              baseline_access_hours
                    - fields: 
                              user_id
                              patient_id
                              care_provider_id
                    - searches: 
                              search_1
                              search_2

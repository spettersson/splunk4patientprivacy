name: Unexpected Prescription
id: b04be6e5-2u02-4349-8742-52111635y8f5
version: 1
author: Simon Pettersson, Splunk
type: Anomaly
status: experimental
description: This search runs continuously to detect staff members prescribing medication to patients without 
        evidence of prior activity that would typically justify the prescription.
data_source: EHR activity data
search: (tag=medication type=medication_request intent=order status=completed) OR
        (tag=appointment status=completed) OR
        (tag=encounter status=completed)
        | fields user_id, patient_id, care_unit_id, care_provider_id, tag, intent, status
        | eval type=case(
        tag="medication_request" AND intent="order" AND status="completed", "medication_ordered",
        tag="appointment" AND status="completed", "appointment_completed",
        tag="encounter" AND status="completed", "encounter_completed",
        true(),null()
        )
        | reverse 
        | streamstats values(type) as values_type reset_after="("type=\"medication_ordered\"")" by user_id, patient_id, care_provider_id
        | reverse
        | search values_type!="appointment_completed" and values_type!="encounter_completed"
        | stats latest_time(eval(type="medication_ordered")) as time_medication_ordered count by user_id, patient_id, care_provider_id
        | convert time_format="%Y-%m-%d %H:%M:%S" ctime(time_medication_ordered) as time_medication_ordered
        | fields user_id, patient_id, care_provider_id, time_medication_ordered
scheduling:
  cron_schedule: '*/10 * * * *'
  earliest_time: -12min@min
  latest_time: -2min@min
how_to_implement: This search requires you to ingest EHR audit data that has the tags auditevent and patientrecord. 
drilldown_searches:
- name: View the detection results
  search: '%original_detection_search% | search  user = "$user$" dest = "$dest$"'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
rba:
  message: User=$user_id$ has successfully prescribed medication to patient=$patient_id$, without the expected prio 
  risk_objects:
  - field: user_id
    type: user
    score: 10
  - field: patient_id
    type: patient
    score: 10
